---
title: "Эконометрика"
author: "Демешев Борис Борисович"
output:
  html_document: default
  pdf_document: default
header-includes: \usepackage[english, russian]{babel}
---
```{r setup, include = F}
library(knitr)      # нужен для ф-ии kable
library(kableExtra) # нужен для ф-ии kable
library(ggplot2)
library(dplyr)      # для обработки данных
library(GGally)     # для матриц диаграмм рассеивания
library(psych)      # для описательных статистик
options(knitr.table.format = "html")
# options(knitr.table.format = "latex")
```

### 2.1.1. Условное математическое ожидание. Определение
Вторая неделя посвящена статистическим свойствам оценок коэффициентов.

* сформулируем стандартные предпосылки
* строить доверительные интервалы для коэфициентов
* проверять гипотезы о коэффициентах

Для того чтобы сформулировать стандартные предпосылки нам потребуется понятие **Условного математического ожидания**.

Рассмотрим это понятие на примере двух случайных величин $r$ и $s$. Мы хотим потстроить такую случайную величину, которая называется **Условным математическим ожиданием** $E(s|r)$ ($E$ от $s$ при условии $r$), которая по смыслу является наиболее похожей на $s$ случайно величиной выражающейся только через $r$.

Формально $E(s|r)$ - это случайная величина $\tilde s$.

С одной стороны $s$ с тильдой является функцией от $r$, а с другой она очень похожа на $s$. А именно мат ожидание от $\tilde s$ равно мат ожиданию от $s$: 
$$E(\tilde s)=E(s)$$

И ковариация между $s$ и любой функцией от $r$ равна ковариации между $\tilde s$  и той же самой функцией от $r$:
$$Cov(s,g(r))=Cov(\tilde s, g(r))$$
В простых случаях если величина $r$ дискретна и принимает значения $a$, $b$ или $c$, то:
$$
E(s|r)=
\left\{
  \begin{aligned}
    &E(s|r=a), \text{ если } r=a \\
    &E(s|r=b), \text{ если } r=b \\
    &E(s|r=c), \text{ если } r=c
  \end{aligned}
\right.
$$

### 2.1.2. Пример подсчета математического ожидания.

Для того чтобы лучше понять концепцию мат ожидания разберем простой пример.

$s, r$ - случайные скалярные величины. Разберем для начала скалярный пример:

$E(s)$ - мат ожидание от $s$, константа

$E(r)$ - мат ожидание от $r$, константа

$E(s|r)$ - случайная величина

Зададим совместное распределение пары $s$ и $r$:
```{r, echo = F}
df <- data.frame(c(0, 10),
                 c(0.25, 0.25),
                 c(0.2, 0.3))
# тут подсмотрел  https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html
kable(df,
      col.names = c("s r", 1, 2)) %>% 
  kable_styling("bordered", 
                full_width = F) %>%  
  column_spec(1, bold = T)
```

Найдем $E(s|r) \text{ и } E(s^2|r)$.

У нас есть определение условного математического ожидания, но оно, к сожалению, не операционно, им неудобно работать, чтобы находить в каждом конкретном случае условное математическое ожидание. Поэтому мы воспользуемся сформулированным результатом, что $E$ от $s$ при условии $r$ — это такая случайная величина, которая принимает значение $E$ от $s$ при условии, что $r = 1$, если $r = 1$, и $E$ от $s$ при условии $r = 2$, если $r = 2$.

$$
E(s|r)=
\left\{
  \begin{aligned}
    &E(s|r=1), \text{ если } r=1 \\
    &E(s|r=2), \text{ если } r=2
  \end{aligned}
\right.
$$

Ну были бы другие значения у r, у нас был бы здесь продолжен список потенциальных значений случайной величины E(s|r).

Перезапишем нашу пару случайных величин в таблицу другого вида. Мы в столбец расположим все возможные исходы и их вероятности.

```{r, echo = F}
df <- data.frame(c(0.25, 0.2, 0.25, 0.3),
                 c(0, 0, 10, 10),
                 c(1, 2, 1, 2))
kable(df,
      col.names = c("P( )", "s", "r")) %>% 
  kable_styling("bordered", 
                full_width = F)
```
Первым шагом посчитаем $E(s|r=1)$. 


```{r, echo = F}
df <- data.frame(c(0.25, 0.2, 0.25, 0.3),
                 c(0, 0, 10, 10),
                 c(1, 2, 1, 2),
                 c(0.5, 0, 0.5, 0))
kable(df,
      col.names = c("P( )", "s", "r", "P(*|r=1)")) %>% 
  kable_styling("bordered", 
                full_width = F)
```
$P()$ - безусловная вероятность

$P(\cdot|r=1)$ - условная вероятность

$E(s|r=1)=\sum_{r=1}(s \times P(\cdot |r=1))=0 \cdot 0.5+10 \cdot 0.5=5$

Теперь то же самое проделываем с $r=2$.

```{r, echo = F}
df <- data.frame(c(0.25, 0.2, 0.25, 0.3),
                 c(0, 0, 10, 10),
                 c(1, 2, 1, 2),
                 c(0, 0.4, 0, 0.6))
kable(df,
      col.names = c("P( )", "s", "r", "P(*|r=2)")) %>% 
  kable_styling("bordered", 
                full_width = F)
```

$E(s|r=2)=\sum_{r=2}(s \times P(\cdot |r=2))=0 \cdot 2/5 + 10 \cdot 3/5=6$

Запишем результат:
$$
E(s|r)=
\left\{
  \begin{aligned}
    &5, \text{ если } r=1 \\
    &6, \text{ если } r=2
  \end{aligned}
\right.
$$

Вот мы получили условное математическое ожидание. Это случайная величина. Почему? Потому что $r$ случайна, соответственно, когда выпадает $r$ и мы узнаём $r$, то мы можем посчитать $E$ от $s$ при условии $r$. И в зависимости от $r$ оно примет своё значение.

А теперь давайте запишем наш ответ в более компактном виде. Отложим наше решение на графике зависимости $E(s|r)$ от $r$. Получим две точки, через которые можно провести прямую. Получается, что вместо длинного условия, можно просто взять ф-ию описывающую наши ответы:

$$E(s|r) = 4 + r$$

И вот в такой постановке совершенно уже понятно, что $E(s|r)$ — это функция от $r$, и кроме того это действительно случайная величина.

Точно таким же образом можно посчитать $E(s^2|r)$. Что же изменится? Нужно в таблицу просто добавить $s^2$.

```{r, echo = F}
df <- data.frame(c(0.25, 0.2, 0.25, 0.3),
                 c(0, 0, 10, 10),
                 c(0, 0, 100, 100),
                 c(1, 2, 1, 2),
                 c(0.5, 0, 0.5, 0),
                 c(0, 0.4, 0, 0.6))
kable(df,
      col.names = c("P( )", "s", "s^2", "r", "P(*|r=1)", "P(*|r=2)")) %>% 
  kable_styling("bordered", 
                full_width = F)
```

Условные вероятности $P(\cdot |r=1)$ и $P(\cdot|r=2)$ не поменяются.

$E(s^2|r=1)=50$

$E(s^2|r=2)=60$

$E(s^2|r)=40 + 10 \cdot r$

И в качестве маленького наблюдения можно заметить такой любопытный факт. Если посчитать мат ожидание от $4+r$, то получится:

$E(4+r)=4+E(r)=4+1\cdot0.5 + 2\cdot0.5=5.5$

А с другой стороны:

$E(s)=0\cdot0.45 + 10\cdot 0.55=5.5$

Таким образом мы на примере проиллюстрировали важное св-во мат ожидания:

Если $\tilde s = E(s|r)$ это условное мат ожидание при известном $r$ $\tilde s = 4+r$, то оказывается что мат ожидание от $\tilde s$ равно  мат ожиданию от $s$ $E(\tilde s)=E(s)$.  

### 2.1.3. Условная дисперсия

Аналогичный способь подсчета есть и у непрерывных величин. Так если пара функций $r$ и $s$ имеют функцию плотности, совместную $f(r, s)$, то можно посчитать условную функцию плотности $f(s|r)=f(r,s)/f(r)$, и проинтегрировав $s$ с помощью этой условной ф-ии 
